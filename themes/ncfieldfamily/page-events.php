<?php/*Template Name: New Custom Event Submission*/?><?php // PHP Validation for Event Form$postTitleError = '';// begin recaptcha$is_valid = apply_filters(‘google_invre_is_valid_request_filter’, true);if( ! $is_valid ) {	echo '<h2>Major reCaptcha Error</h2>';} else {if ( isset( $_POST['submitted'] ) && isset( $_POST['post_nonce_field'] ) && wp_verify_nonce( $_POST['post_nonce_field'], 'post_nonce' ) ) {     if ( trim( $_POST['postTitle'] ) === '' ) {        $postTitleError = 'Please enter a title.';        $hasError = true;    }		$subregion = $_POST['region'];	$myterm = get_term_by('name', $subregion, 'region');	$termParent = get_term($myterm->parent, 'region');	$termParentName = $termParent->name;	$t = explode('-',$_POST['startDate']);	$month = $t[1]; //month 	if ($month == '12' || $month == '01' || $month == '02') {$season = 'Winter';} 	if ($month == '03' || $month == '04' || $month == '05') {$season = 'Spring';} 	if ($month == '06' || $month == '07' || $month == '08') {$season = 'Summer';} 	if ($month == '09' || $month == '10' || $month == '11') {$season = 'Fall';}	    $post_information = array(        'post_title' => $_POST['postTitle'],        'post_content' => $_POST['postContent'],        'post_type' => 'events',        'post_status' => 'pending',		'meta_input'   => array(			'start_date' => $_POST['startDate'],			'location' => $_POST['location'],			'phone_number' => $_POST['phone_number'],			'event_url' => $_POST['event_url'],			'event_email' => $_POST['event_email'],			'start_time' => $_POST['startTime'],			'end_time' => $_POST['endTime'],			'end_date' => $_POST['endDate'],			'event_source' => 'Front End'		),    );        $post_id = wp_insert_post( $post_information );	wp_set_object_terms( 		$post_id, 		array( 			$subregion, 			$termParentName		), 		'region'	);	wp_set_object_terms( 		$post_id, 		$season,		'season'	);	wp_set_object_terms( 		$post_id, 		$_POST['event_type'], 		'event_type'	);    	if ( $post_id ) {		$thanks = yes;	}		// Handles File Upload			if ($_FILES['image']['size'] !== 0) {			$upload = wp_upload_bits( $_FILES['image']['name'], null, file_get_contents( $_FILES['image']['tmp_name'] ) );			$wp_filetype = wp_check_filetype( basename( $upload['file'] ), null );			$wp_upload_dir = wp_upload_dir();			$attachment = array(				'guid' => $wp_upload_dir['baseurl'] . _wp_relative_upload_path( $upload['file'] ),				'post_mime_type' => $wp_filetype['type'],				'post_title' => preg_replace('/\.[^.]+$/', '', basename( $upload['file'] )),				'post_content' => '',				'post_status' => 'inherit'			);			$attach_id = wp_insert_attachment( $attachment, $upload['file'], $post_id );			require_once(ABSPATH . 'wp-admin/includes/image.php');			$attach_data = wp_generate_attachment_metadata( $attach_id, $upload['file'] );			wp_update_attachment_metadata( $attach_id, $attach_data );			update_post_meta( $post_id, '_thumbnail_id', $attach_id );		}		// Email the user// 	$projbody = '// 		Thank you for your event submission to the Tennessee Home & Farm. Your event will appear in our list once it is approved.<br><br>// 		Title: ' . $POST['postTitle'] . '<br><br>// 		Region: ' . $POST['region'] . '<br>// 		City: ' . $POST['location'] . '<br><br>// 		' . $season . '<br>// 		' . $POST['startDate'] . ' - ' . $POST['endDate'] . '<br>// 		' . $POST['startTime'] . ' - ' . $POST['endTime'] . '<br><br>// 		Category: ' . $POST['event_type'] . '<br><br>// 		' . $POST['postContent'] . '<br><br>// 		Event phone: ' . $POST['phone_number'] . '<br>// 		Website: ' . $POST['event_url'] . '<br>';// 		// 	$projto = $_POST['event_email'];// 	$projfrom = 'Tennessee Home &amp; Farm';// 	$projsubject = 'THF Event Submission - ' . $_POST['postTitle'];// 	$fromEmail = 'thaf@farmflavormedia.com';// 	$from = 'Tennessee Home &amp; Farm';// 	$replyTo = 'thaf@farmflavormedia.com';// 	$headers['From']    = 'From: '.$from;       // 	$headers['Reply-To'] = 'Reply-To: '.$replyTo;// 	wp_mail($projto, $projsubject, $projbody, $headers);}} // end recaptcha?><?php get_header(); ?>	<div id="content-wrapper">		<?php if (have_posts()) : while (have_posts()) : the_post(); ?>		<div id="content-main" class="content-full">			<div id="home-main" class="home-full">				<div id="post-area">					<h1 class="story-title"><?php the_title(); ?></h1>					<div id="content-area"><?php if (isset($thanks)) { ?>	<h2>Thank you!</h2>	<p>Thanks for submitting your event! Our editors will review your event submission and publish it shortly.</p>	<div style="min-height:500px;">&nbsp;</div><?php } else { ?><?php the_content(); ?><form action="" id="primaryPostForm" class="event-form" method="POST" enctype="multipart/form-data">    <fieldset><?php if ( $postTitleError != '' ) { ?>    <span class="error"><?php echo $postTitleError; ?></span>    <div class="clearfix"></div><?php } ?>        <label for="postTitle"><?php _e('Event Title: *', 'framework') ?></label>        <div class="event-label-descrip">The title of the event</div>        <input type="text" name="postTitle" id="postTitle" required value="<?php if ( isset( $_POST['postTitle'] ) ) echo $_POST['postTitle']; ?>" />    </fieldset>    <fieldset>        <label for="startDate"><?php _e('Event Start Date: *', 'framework') ?></label>        <div class="event-label-descrip">Select the date your event starts</div>        <input type="date" name="startDate" required id="startDate">    </fieldset>    <fieldset>        <label for="startTime"><?php _e('Event Start Time:', 'framework') ?></label>        <div class="event-label-descrip">The time your event starts. (Hour : Minute AM/PM)</div>        <input type="time" name="startTime" id="startTime">    </fieldset>    <fieldset>        <label for="endTime"><?php _e('Event End Time:', 'framework') ?></label>        <div class="event-label-descrip">The time your event ends. (Hour : Minute AM/PM)</div>        <input type="time" name="endTime" id="endTime">    </fieldset>    <fieldset>        <label for="endDate"><?php _e('Event End Date:', 'framework') ?></label>        <div class="event-label-descrip">If your event spans multiple days, select the date your event ends</div>        <input type="date" name="endDate" id="endDate">    </fieldset>       <fieldset>    	<label for="region"><?php _e('Region: *', 'framework') ?></label>    	<div class="event-label-descrip"></div>    	<select id="region" name="region" required="required">    		<option selected disabled value="">Select a region</option>			<optgroup label="East Tennessee">				<option>Chattanooga &amp; Southeast</option>				<option>Knoxville &amp; Surrounding Areas</option>				<option>Northeast</option>				<option>Smoky Mountains</option>			</optgroup> 			<optgroup label="Middle Tennessee">				<option>Nashville &amp; Surrounding Areas</option>				<option>South Central</option>				<option>Upper Cumberland</option>			</optgroup>			<optgroup label="West Tennessee">				<option>Memphis &amp; Surrounding Areas</option>				<option>Northwest</option>				<option>Southwest</option></select>			</optgroup>		</select>    </fieldset>    <fieldset>        <label for="location"><?php _e('City: *', 'framework') ?></label>        <div class="event-label-descrip"></div>        <input type="text" name="location" id="location" required>    </fieldset>	<fieldset>		<label for="event_type"><?php _e('Event Category: *', 'framework') ?></label>		<div class="event-label-descrip"></div>		<select id="event_type" name="event_type" required="required">			<option selected disabled value="">Select an Event Type</option>			<?php			   $tax_terms = get_terms('event_type', array('hide_empty' => '0'));      			   foreach ( $tax_terms as $tax_term ):  				  echo '<option value="'.$tax_term->name.'">'.$tax_term->name.'</option>';   			   endforeach;			?>		</select>	</fieldset>    <fieldset>        <label for="postContent"><?php _e('Event Description:', 'framework') ?></label>        <div class="event-label-descrip">Describe your event. No HTML or other code allowed</div>        <textarea name="postContent" id="postContent" rows="8" cols="30"><?php if ( isset( $_POST['postContent'] ) ) { if ( function_exists( 'stripslashes' ) ) { echo stripslashes( $_POST['postContent'] ); } else { echo $_POST['postContent']; } } ?></textarea>    </fieldset>    <fieldset>        <label for="phone_number"><?php _e('Event Phone Number:', 'framework') ?></label>        <div class="event-label-descrip">Phone number for general information about the event. Please format like (XXX) XXX-XXXX</div>        <input type="tel" name="phone_number" id="phone_number">    </fieldset>    <fieldset>        <label for="event_url"><?php _e('Event Website:', 'framework') ?></label>        <div class="event-label-descrip">Enter the website URL for the event including the http:// (like http://www.example.com)</div>        <input type="url" name="event_url" id="event_url">    </fieldset>    <fieldset>        <label for="event_email"><?php _e('Your email: *', 'framework') ?></label>        <div class="event-label-descrip">Your email is only for internal use and will not appear on the listing</div>        <input type="email" name="event_email" id="event_email" required>    </fieldset>    <fieldset>        <label for="file-upload"><?php _e('Event Image:', 'framework') ?></label>        <div class="event-label-descrip">Upload an event image if you have one. The image will appear below your event description and will have a maximum width of 620 pixels. Maximum upload size is 1MB</div>        <input type="file" name="image" id="file-upload" accept="image/*">    </fieldset>    <fieldset>        <input type="hidden" name="submitted" id="submitted" value="true" />        <?php wp_nonce_field( 'post_nonce', 'post_nonce_field' ); ?>        <?php wp_nonce_field( 'file-upload', 'file-upload_nonce' ); ?>        <?php do_action(‘google_invre_render_widget_action’); ?>        <input type="submit" value="Submit">    </fieldset><script>var eventurl = document.getElementById("event_url");eventurl.addEventListener("input", function (event) {  if (eventurl.validity.typeMismatch) {    eventurl.setCustomValidity("Please include the http://");  } else {    eventurl.setCustomValidity("");  }});</script>    </form><?php } ?>										<?php // echo do_shortcode('[gravityforms id=1 field_values="region=' . $region->name . '"]'); ?>					</div><!--content-area-->				</div><!--post-area-->			</div><!--home-main-->		</div><!--content-main-->		<?php // get_sidebar(); ?>		<?php endwhile; endif; ?>	</div><!--content-wrapper--></div><!--main-wrapper--><?php get_footer(); ?>